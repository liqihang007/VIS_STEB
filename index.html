<!DOCTYPE html> 
<meta charset="utf-8">
<html>
  <head>
    <style>
      body {
      margin: 0px;
      padding: 0px;
      font: 12px Arial;
    }
    </style>
    <script src="http://d3js.org/d3.v3.js"></script>
  </head>
  
  <body>
  	<div id="BGEFM_fig" style="height: 1000px;" style="weight: 900px;">  </div>
  	<div id="BGEFM_zoom">  </div>
    <script type="text/javascript">
      	// <div id="BGEFM_fig" style="height: 850px;" style="weight: 900px;">  </div>
	// d3.csv('BGEFM_data_all.csv', function(data){
	//   document.write(JSON.stringify(data));
	// })
	// var data; // a global
	// d3.json("BGEFM.json", function(d) {
	// 	data=d;
	// 	console.log(data);
	// });
    //load BGEFM data
    //load 1792-2063 label matrix // fullData/BGEFM_
	d3.text("fullData/BGEFM_data.csv", function(text) {
  		var data = d3.csv.parseRows(text).map(function(row) {
    		return row.map(function(value) {
      			return +value;
			});
  		});
  		d3.csv("fullData/BGEFM_gene.csv", function(d) {
			var genes=d;
			d3.csv("fullData/BGEFM_structure.csv", function(d) {
				var structures=d;

				// global color codes
				var colorCode = ["#000000","#0000FF","#00FFFF",
					"#33CC33","#E6E600","#FF6600","#FF0000"];

				// global var for page range
				var margin = {
				    top: 100,
				    right: 20,
				    bottom: 20,
				    left: 20
				};

				// global var for the BGEFM image
				var img = new Image();
				var img_width = 950;
				var img_height = 824;

				//The number of columns and rows of the zoomed data
				var mapCols = 60;
				var	mapRows = 60;
				var mapCols2 = mapCols / structures.length * img_width;
				var	mapRows2 = mapRows / genes.length * img_height;
				var cellSize = 10;
				var offSet = 1;
				var width = mapCols * (cellSize + offSet);
				var heigth = mapRows * (cellSize + offSet);
				var BGEFM_Url = 'BGEFM_fig.png';

				// SVG of zoomed data
				var svgZoom = d3.select("#BGEFM_zoom").append("svg")
					.attr('id','svgZoom')
				    .attr("width", width + margin.left + margin.right + 50)
				    .attr("height", heigth + margin.top + margin.bottom )
				    .style('position','absolute')
					.style('top',margin.top)
					.style('left',margin.left + 900);

				// SVG of zoomed gene labels
				var svgGene = d3.select("#BGEFM_zoom").append("svg")
				    .attr("width", 80)
				    .attr("height", heigth + margin.top + margin.bottom )
				    .style('position','absolute')
					.style('top',margin.top)
					.style('left',margin.left + width + 950 + 10);

				// SVG of zoomeD structure labels
				var svgStructure = d3.select("#BGEFM_zoom").append("svg")
				    .attr("width", width + margin.left + margin.right + 50)
				    .attr("height", 100)
				    .style('position','absolute')
					.style('top',0)
					.style('left',margin.left + 900);

				// drag behavior of the zoomed box in BGEFM
				var dragBox = d3.behavior.drag()
    				.origin(Object)
    				.on("drag", function(d){
    					var pos = d3.mouse(this);
    					var xst = pos[0] - mapCols2/2;
    					if (xst < margin.left) xst = margin.left;
    					if (xst > margin.left + img_width - mapCols2) xst = margin.left + img_width - mapCols2;
    					var yst = pos[1] - mapRows2/2;
    					if (yst < margin.top) yst = margin.top;
    					if (yst > margin.top + img_height - mapRows2) yst = margin.top + img_height - mapRows2;
						rectangle
							.attr("x",xst)
							.attr("y",yst);
    					drawZoomMatrix(xst,yst);
    				});

    			// SVG of BGEFM
				var svgBGEFM = d3.select("#BGEFM_fig").append("svg")
								 .attr('id','svgBGEFM')
								 .attr("width", img_width+margin.left)
   								 .attr("height", img_height+margin.top);

				// show the BGEFM image
				var svg_img = svgBGEFM.append('image')
						  	.attr('image-rendering','optimizeQuality')
						  	.attr('x',margin.left)
							.attr('y',margin.top);
				img.src = BGEFM_Url;
				img.onload = function() {
					svg_img.attr('height', img_height)
				  		    .attr('width',img_width)
				  		    .attr('xlink:href', BGEFM_Url)
				  		    .attr('image-rendering','optimizeQuality');
				}

				// draw the zoomed box in BGEFM
    			var rectangle = svgBGEFM.append("rect")
				    			.attr("x", margin.left)
				      			.attr("y", margin.top)
				      			.attr("height", mapCols2)
							    .attr("width", mapRows2)
							    .style("stroke", "white")
                                .style("stroke-width",2)
                                .style("fill-opacity", 0)
							    .call(dragBox);

				function drawZoomMatrix(xst,yst){
					// zoomed box in BGEFM
					var xnd = xst + mapCols;
					var ynd = yst + mapRows;
					// zoomed data
					var data_xst = Math.round((xst - margin.left) / img_width * structures.length ) 
					var data_xnd = data_xst + mapCols;
					var data_yst = Math.round((yst - margin.top) / img_height * genes.length );
					var data_ynd = data_yst + mapRows;
					var data_zoom = data.slice(data_yst, data_yst + mapRows);
					for(var i = 0; i<data_zoom.length; i++){
					    data_zoom[i] = data_zoom[i].slice(data_xst, data_xst + mapCols);
					}
					var genes_zoom = genes.slice(data_yst, data_yst + mapRows);
					var structures_zoom = structures.slice(data_xst, data_xst + mapRows);
					// console.log(data_zoom[0][0] + " " + genes_zoom[0].GENE );
					console.log(xst+" "+xnd+" "+yst+" "+ynd+" -> "+data_xst+" "+data_xnd+" "+data_yst+" "+data_ynd);
					// console.log(structures_zoom[0].STRUCTURE);

					// redraw the zoomed matrix
					svgZoom.selectAll(".rect").remove();
					svgZoom.append("g").selectAll(".rect")
					    .data(data_zoom)
					    .enter()
					    .append('g')
					    .attr("class","rect")
					    .attr('transform', function(d, i) {
					        return 'translate(0, ' + (cellSize + offSet) * i + ')';
					    })
						.selectAll('.rect')
					    .data(function(d) { return d; })
					    .enter()
					    .append('rect')
					    .attr('x', function(d, i) {
					    	return (cellSize + offSet) * i + 60; 
					    })
					    .attr('width', cellSize)
					    .attr('height', cellSize)
					    .style("fill", function(d) { return colorCode[d]; });

					// redraw the zoomed gene labels
					svgGene.selectAll(".geneLabel").remove();
					svgGene.selectAll(".geneLabel")
						.data(genes_zoom)
						.enter()
						.append('g')
						.attr("class","geneLabel")
						.append('text')
						.attr('x', 0)
						.attr('y', function(d,i) {
							return ( 8 + (cellSize + offSet) * i);
						})
						.attr("font-family", "sans-serif")
				        .attr("font-size", "10px")
					    .attr("fill", "#000000")
						.text(function(d,i) {return genes_zoom[i].GENE;});

					// redraw the zoomed structure labels
					svgStructure.selectAll(".structureLabel").remove();
					svgStructure.selectAll(".structureLabel")
						.data(structures_zoom)
						.enter()
						.append('g')
						.attr("class","structureLabel")
						.append('text')
						.attr('x', -98)
						.attr('y', function(d,i) {
							return ( 68 + (cellSize + offSet) * i);
						})
						.attr("transform", "rotate(-90)")
						.attr("font-family", "sans-serif")
				        .attr("font-size", "10px")
					    .attr("fill", "#000000")
						.text(function(d,i) {return structures_zoom[i].STRUCTURE;});
				} // function drawZoomMatrix(xst, yst)
			}); // d3.csv structures
		}); // d3.csv genes
	}); // d3.text data
    </script>
  </body>
</html>